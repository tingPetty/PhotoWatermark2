# PhotoWatermark2 技术架构设计

## 1. 技术栈选择

### 1.1 核心框架
- **GUI框架**: PyQt6
  - 选择理由：
    - 成熟稳定的跨平台GUI框架
    - 丰富的组件库和完善的文档
    - 良好的性能和原生外观
    - 支持自定义样式
    - 活跃的社区支持

### 1.2 图像处理
- **主要库**: Pillow (PIL)
  - 选择理由：
    - Python图像处理的标准库
    - 支持多种图片格式
    - 提供完整的图像处理功能
    - 性能优秀
    - 文档完善

### 1.3 其他依赖
- **配置管理**: JSON
  - 用于保存和加载水印模板配置
  - 轻量级，易于解析和维护
- **路径处理**: os.path
  - 跨平台路径处理
- **打包工具**: PyInstaller
  - 将Python应用打包为独立可执行文件

## 2. 架构设计

### 2.1 整体架构
```
PhotoWatermark2/
├── src/                        # 源代码目录
│   ├── main.py                # 程序入口
│   ├── ui/                    # UI相关代码
│   │   ├── main_window.py     # 主窗口
│   │   ├── ui_components.py   # UI组件
│   │   ├── event_handlers.py  # 事件处理
│   │   ├── watermark_handler.py # 水印处理
│   │   ├── file_manager.py    # 文件管理
│   │   ├── template_manager.py # 模板管理
│   │   └── dialogs/           # 对话框组件
│   │       ├── export_dialog.py    # 导出对话框
│   │       └── template_dialog.py  # 模板对话框
│   ├── core/                  # 核心功能
│   │   └── image_processor.py # 图像处理
│   └── utils/                 # 工具函数
├── resources/                 # 资源文件
│   ├── icons/                # 图标
│   └── styles/               # 样式表
├── tests/                    # 测试图片
├── docs/                     # 文档
├── dist/                     # 发布文件
├── run.py                    # 启动脚本
├── watermark_templates.json  # 模板配置文件
└── last_watermark_settings.json # 上次设置文件
```

### 2.2 模块设计

#### 2.2.1 UI模块
- **MainWindow**: 主窗口类
  - 负责整体布局和窗口管理
  - 初始化所有子组件
  - 管理应用程序状态
  - 处理拖拽事件

- **UIComponents**: UI组件类
  - 创建和管理所有UI控件
  - 负责布局设计
  - 菜单栏和工具栏创建
  - 状态栏管理

- **EventHandlers**: 事件处理类
  - 处理所有用户交互事件
  - 连接信号和槽
  - 管理水印参数更新
  - 处理模板操作

- **WatermarkHandler**: 水印处理类
  - 水印渲染和预览
  - 位置计算和拖拽处理
  - 缓存机制优化
  - 实时预览更新

- **FileManager**: 文件管理类
  - 图片文件的导入和导出
  - 文件格式验证
  - 批量处理功能
  - 文件路径管理

- **TemplateManager**: 模板管理类
  - 水印模板的保存和加载
  - 模板数据的序列化
  - 默认设置管理
  - 模板列表维护

#### 2.2.2 对话框模块
- **ExportDialog**: 导出对话框
  - 导出参数设置
  - 质量和尺寸调整
  - 文件格式选择

- **TemplateDialog**: 模板对话框
  - 模板管理界面
  - 模板的增删改查
  - 模板预览功能

#### 2.2.3 核心模块
- **ImageProcessor**: 图像处理类
  - 图片加载和保存
  - 格式转换和验证
  - 缩略图生成
  - PIL和QPixmap转换
  - 图片信息获取

### 2.3 数据流设计

#### 2.3.1 图片导入流程
```
文件选择/拖拽 → 格式验证 → ImageProcessor加载 → 缩略图生成 → 列表显示 → 预览更新
```

#### 2.3.2 水印应用流程
```
水印参数设置 → EventHandlers处理 → WatermarkHandler渲染 → 缓存优化 → 实时预览 → 导出处理
```

#### 2.3.3 模板管理流程
```
当前设置获取 → TemplateManager序列化 → JSON存储 → 模板列表更新 → 加载应用 → 参数恢复
```

#### 2.3.4 性能优化流程
```
图片缓存 → 预览缩放 → 节流更新 → 延迟渲染 → 内存管理
```

## 3. 性能优化策略

### 3.1 图片处理优化
- **缓存机制**: WatermarkHandler实现图片缓存，避免重复加载和缩放
- **智能缩放**: 预览时自动缩放到合适尺寸，保持宽高比
- **格式验证**: ImageProcessor提前验证文件格式，避免无效加载
- **缩略图生成**: 为图片列表生成小尺寸缩略图，提升显示速度

### 3.2 UI响应优化
- **节流更新**: EventHandlers实现节流机制，控制预览更新频率
- **延迟渲染**: 使用QTimer延迟处理频繁的鼠标移动事件
- **异步处理**: 耗时操作使用异步处理，避免界面卡顿
- **事件优化**: 优化拖拽事件处理，提升交互流畅度

### 3.3 内存管理
- **缓存清理**: 图片切换时自动清理缓存，释放内存
- **资源管理**: 及时释放不再使用的QPixmap对象
- **状态检查**: 定期检查缓存状态，避免内存泄漏

### 3.4 数据持久化优化
- **JSON格式**: 使用轻量级JSON格式存储模板和设置
- **增量保存**: 只在设置变更时保存，避免频繁IO操作
- **错误处理**: 完善的异常处理机制，确保数据完整性

## 4. 功能特性

### 4.1 核心功能
- **多格式支持**: 支持JPG、PNG、BMP、TIFF等主流图片格式
- **文本水印**: 支持自定义文本、字体、大小、颜色、透明度
- **图片水印**: 支持PNG透明背景图片作为水印
- **位置控制**: 九宫格定位 + 自由拖拽定位
- **实时预览**: 所见即所得的实时预览效果

### 4.2 高级功能
- **文本特效**: 支持阴影效果和描边效果
- **描边颜色**: 可自定义描边颜色
- **旋转角度**: 支持0-360度任意角度旋转
- **批量处理**: 支持批量导入和批量导出
- **模板系统**: 完整的水印模板保存、加载、管理功能

### 4.3 用户体验
- **拖拽导入**: 支持拖拽文件和文件夹导入
- **快捷操作**: 丰富的快捷键支持
- **状态提示**: 实时状态栏信息显示
- **设置记忆**: 自动保存和恢复上次使用的设置
- **关于对话框**: 完整的应用程序信息展示

### 4.4 界面设计
- **简洁布局**: 清晰的功能分区和直观的操作流程
- **响应式设计**: 自适应窗口大小变化
- **现代UI**: 符合现代应用设计规范的界面风格

## 5. 测试策略

### 5.1 单元测试
- 核心功能模块测试
- 图片处理功能测试
- 模板管理测试
- 事件处理测试

### 5.2 集成测试
- UI功能测试
- 模块间交互测试
- 性能测试
- 水印渲染测试

### 5.3 用户界面测试
- 可用性测试
- 界面响应测试
- 异常处理测试
- 拖拽功能测试

## 6. 部署策略

### 6.1 打包流程
1. 收集依赖
2. 优化资源文件
3. 使用PyInstaller打包
4. 生成独立可执行文件

### 6.2 发布检查
- 运行环境测试
- 功能完整性验证
- 性能测试
- 安装包大小优化

### 6.3 更新机制
- 版本号管理
- 更新日志维护
- 配置文件兼容性处理
- 模板文件向后兼容